import numpy as np

import horton as ht
from saddle.newopt.grape import Grape
from saddle.newopt.saddle_point import SaddlePoint
from saddle.reduced_internal import ReducedInternal


class TestGrape(object):
    @classmethod
    def setup_class(self):
        fn_xyz = ht.context.get_fn("test/water.xyz")
        mol = ht.IOData.from_file(fn_xyz)  # create a water molecule
        self.ri = ReducedInternal(mol.coordinates, mol.numbers, 0, 1)
        self.ri.add_bond(0, 1)
        self.ri.add_bond(1, 2)
        self.ri.add_angle_cos(0, 1, 2)
        self.ri.set_key_ic_number(1)
        self.ri.set_new_coordinates(
            np.array([[0.00000000e+00, 1.48124293e+00, -8.37919685e-01], [
                0.00000000e+00, 3.42113883e-49, 2.09479921e-01
            ], [-1.81399942e-16, -1.48124293e+00, -8.37919685e-01]]))
        self.ri._energy = -76.3856892935073
        self.ri._energy_gradient = np.array(
            [1.79016197e-17, -1.14393578e-02, 8.56031577e-03, 7.42919139e-16,
             2.13370988e-16, -1.71206315e-02, -7.60820759e-16, 1.14393578e-02,
             8.56031577e-03])
        self.ri._energy_hessian = np.array(
            [[-7.99278901e-03, 1.13049265e-13, -1.69204779e-13, 8.20209517e-03,
              -1.23901570e-12, -1.48730466e-12, -2.09306165e-04,
              1.13811665e-12, 3.10484455e-12],
             [1.13049265e-13, 4.02310139e-01, -2.30853436e-01, -4.72243644e-13,
              -3.71668821e-01, 1.93062118e-01, 1.13811406e-12, -3.06413180e-02,
              3.77913184e-02],
             [-1.69204779e-13, -2.30853436e-01, 1.87408974e-01, 2.43251039e-12,
              2.68644754e-01, -1.92593033e-01, -3.10484110e-12,
              -3.77913184e-02, 5.18405956e-03],
             [8.20209517e-03, -4.72243644e-13, 2.43251039e-12, -1.64041903e-02,
              1.35624049e-12, -2.62930325e-12, 8.20209517e-03, -2.37809080e-13,
              -2.10845134e-12],
             [-1.23901570e-12, -3.71668821e-01, 2.68644754e-01, 1.35624049e-12,
              7.43337643e-01, 4.71279266e-11, -1.90889518e-12, -3.71668821e-01,
              -2.68644754e-01], [
                  -1.48730466e-12, 1.93062118e-01, -1.92593033e-01,
                  -2.62930325e-12, 4.71279266e-11, 3.85186067e-01,
                  3.79292664e-12, -1.93062118e-01, -1.92593033e-01
              ], [2.09306165e-04, 1.13811406e-12, -3.10484110e-12,
                  8.20209517e-03, -1.90889518e-12, 3.79292664e-12,
                  -7.99278901e-03, 1.12443136e-13, 1.68823548e-13], [
                      1.13811665e-12, -3.06413180e-02, -3.77913184e-02,
                      -2.37809080e-13, -3.71668821e-01, -1.93062118e-01,
                      1.12443136e-13, 4.02310139e-01, 2.30853436e-01
                  ], [3.10484455e-12, 3.77913184e-02, 5.18405956e-03,
                      -2.10845134e-12, -2.68644754e-01, -1.92593033e-01,
                      1.68823548e-13, 2.30853436e-01, 1.87408974e-01]])

        self.ri._internal_gradient = np.array(
            [-0.0142825, -0.0142825, -0.00074069])
        self.ri._internal_hessian = np.array(
            [[0.54831182, -0.01345925, -0.04730117],
             [-0.01345925, 0.54831182, -0.04730117],
             [-0.04730117, -0.04730117, 0.18274632]])
        # self.ri._vspace_gradient = np.array(
        #     [-0.0142825, -0.01240347, -0.00711985])
        # self.ri._vspace_hessian = np.array(
        #     [[0.54831182, 0.00938767, -0.04827446],
        #      [0.00938767, 0.51170175, 0.11950097],
        #      [-0.04827446, 0.11950097, 0.21935639]])

    def test_vspace_value(self):
        ref_vspace = np.array(
            [[1.00000000e+00, 2.19203002e-16, 3.63182638e-17],
             [-2.22044605e-16, 8.91892117e-01, 4.52248219e-01],
             [5.89805982e-17, -4.52248219e-01, 8.91892117e-01]])
        print self.ri.vspace
        print self.ri._red_space

        # assert np.allclose(self.ri.vspace, ref_vspace)
        assert False
